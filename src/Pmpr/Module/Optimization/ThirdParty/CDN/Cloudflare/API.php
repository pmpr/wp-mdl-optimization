<?php
/*   _______________________________________
    |  Obfuscated by PMPR - Php Obfuscator  |
    |             6889ff6f307ad             |
    |_______________________________________|
*/
 namespace Pmpr\Module\Optimization\ThirdParty\CDN\Cloudflare; use Exception; use GuzzleHttp\Cookie\CookieJar; use Pmpr\Common\Foundation\API\API as BaseClass; use Pmpr\Common\Foundation\Interfaces\Constants; use Pmpr\Module\Optimization\Optimization; use WP_Error; class API extends BaseClass { const kcyyywioiaimkqks = 'X-Auth-Key'; const sskckkiuimayuoeg = 'X-Auth-Email'; const gqkuwmsyysusmquw = 'text/html,application/xhtml+xml,application/xml;q=0.9,' . 'image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3'; const keasgekkgaeuueau = 'Mozilla/5.0 (Linux; Android 7.0; Moto G (4)) AppleWebKit/537.36 ' . '(KHTML, like Gecko) Chrome/84.0.4143.7 Mobile Safari/537.36 Chrome-Lighthouse'; const guaqqecaewyquueo = 'http_request_cache_settings'; protected ?string $email = ''; protected ?string $zoneId = ''; protected ?string $apiKey = ''; protected ?string $cfDomain = ''; protected ?string $apiToken = ''; protected ?string $authMode = ''; protected array $accountIds = []; public function __construct() { $this->suyquyoaausqsuay('https://api.cloudflare.com/client/v4'); $aqimoomqmscqikma = Cloudflare::symcgieuakksimmu(); $this->email = $aqimoomqmscqikma->weysguygiseoukqw(Setting::yeeemccgmikyeiqq); $this->apiKey = $aqimoomqmscqikma->weysguygiseoukqw(Setting::ekecawsykcwisikm); $this->zoneId = $aqimoomqmscqikma->weysguygiseoukqw(Setting::iqksqseqeqmaukkk); $this->authMode = $aqimoomqmscqikma->weysguygiseoukqw(Setting::uksumkeyuauyuiqm, Setting::fsekswokoseswcqm); $this->cfDomain = $aqimoomqmscqikma->weysguygiseoukqw(Setting::kiuyeswmgaikeiuo); $this->apiToken = $aqimoomqmscqikma->weysguygiseoukqw(Setting::uwkciiskgyqaigqe); parent::__construct(); $this->iwoewaiwqaisaagy(); if ($this->caeygcowcuqeqkeo() === Setting::eywauigiwgqckygk) { $this->amskqmemsacmksye($this->gkuoyaqwcaqcqmck()); } else { $this->kiaqywwoysssqgig(self::kcyyywioiaimkqks, $this->aocqkkgewgggwwys())->kiaqywwoysssqgig(self::sskckkiuimayuoeg, $this->cseqaqmuaswgwuoo()); } $this->ueakuaywsqiooygo(20); } public function kmegomwosoueimki() : array { return $this->accountIds; } public function cseqaqmuaswgwuoo() : ?string { return $this->email; } public function mekmkysuwsuseaow() : ?string { return $this->zoneId; } public function sawoqaskqkasksge() : ?string { return $this->cfDomain; } public function aocqkkgewgggwwys() : ?string { return $this->apiKey; } public function gkuoyaqwcaqcqmck() : ?string { return $this->apiToken; } public function caeygcowcuqeqkeo() : ?string { return $this->authMode; } public function iqokecwcgkaookuc() { $ksaameoqigiaoigg = []; $yeacayasgueouoqc = 1; $weyoqgcesqgeusiu = 50; $ymiyawysimukkoso = false; do { $qiouiwasaauyaaue = $this->gkwkqmwweiawigae(); $cokqekgqeigaoqsy = $this->sawoqaskqkasksge(); $wegekcwgakqeqsmq = $this->caeygcowcuqeqkeo(); $mkomwsiykqigmqca = '/zones'; if ($cokqekgqeigaoqsy && $wegekcwgakqeqsmq === Setting::eywauigiwgqckygk) { $mkomwsiykqigmqca = $this->uwkmaywceaaaigwo()->owicscwgeuqcqaig()->yqymaqmqiqmmmsoo(Constants::NAME, $cokqekgqeigaoqsy, $mkomwsiykqigmqca); } else { $mkomwsiykqigmqca = $this->uwkmaywceaaaigwo()->owicscwgeuqcqaig()->yqymaqmqiqmmmsoo([Constants::imywcsggckkcywgk => $yeacayasgueouoqc, Constants::ausqeuugegoygouq => $weyoqgcesqgeusiu], $mkomwsiykqigmqca); } $keccaugmemegoimu = $this->get($mkomwsiykqigmqca, $qiouiwasaauyaaue); if ($this->occymigcemkqucuw($keccaugmemegoimu, $iswcokucwmiosiaq)) { $gkyciwoiiisgywcs = $this->caokeucsksukesyo()->ywqgcuymeiswqyqc(); $sogksuscggsicmac = $this->qemyqseaomicaacs($keccaugmemegoimu); if ($this->yquuyiaogsgwmaem($sogksuscggsicmac, $iswcokucwmiosiaq)) { $yyimiwcuegayoskq = $gkyciwoiiisgywcs->get($sogksuscggsicmac, 'result_info', []); if ($yyimiwcuegayoskq && is_array($yyimiwcuegayoskq)) { $saawqymgwcseukqa = $gkyciwoiiisgywcs->get($yyimiwcuegayoskq, 'total_pages'); if ($saawqymgwcseukqa && (int) $saawqymgwcseukqa > $yeacayasgueouoqc) { $ymiyawysimukkoso = true; $yeacayasgueouoqc++; } else { $ymiyawysimukkoso = false; } } else { if ($ymiyawysimukkoso) { $ymiyawysimukkoso = false; } } $sogksuscggsicmac = $gkyciwoiiisgywcs->get($sogksuscggsicmac, Constants::syomkiqgogwyuiyw, []); if ($sogksuscggsicmac && is_array($sogksuscggsicmac)) { foreach ($sogksuscggsicmac as $icwicymcioeyeyek) { $aokagokqyuysuksm = $gkyciwoiiisgywcs->get($icwicymcioeyeyek, Constants::gouqcwikiiygyasc); $ymqmyyeuycgmigyo = $gkyciwoiiisgywcs->get($icwicymcioeyeyek, Constants::NAME); if ($aokagokqyuysuksm && $ymqmyyeuycgmigyo) { $ksaameoqigiaoigg[$aokagokqyuysuksm] = $ymqmyyeuycgmigyo; } else { $iswcokucwmiosiaq = __('Unable to retrive zone id due to invalid response data', PR__MDL__OPTIMIZATION); break; } } } } } if ($iswcokucwmiosiaq) { $ksaameoqigiaoigg = $this->caokeucsksukesyo()->euekiyuksecoccus()->gosmqcmmomkqwmis($iswcokucwmiosiaq); } } while ($ymiyawysimukkoso); if (!$ksaameoqigiaoigg) { $ksaameoqigiaoigg = $this->caokeucsksukesyo()->euekiyuksecoccus()->gosmqcmmomkqwmis(__('Unable to find domains configured on Cloudflare', PR__MDL__OPTIMIZATION)); } return $ksaameoqigiaoigg; } public function smayommusayuweky(string $qcsumeqqumqgymei) { $ksaameoqigiaoigg = ''; $keccaugmemegoimu = $this->get("/zones/{$this->mekmkysuwsuseaow()}/rulesets"); if ($this->occymigcemkqucuw($keccaugmemegoimu, $iswcokucwmiosiaq)) { $sogksuscggsicmac = $this->qemyqseaomicaacs($keccaugmemegoimu); if ($this->yquuyiaogsgwmaem($sogksuscggsicmac, $iswcokucwmiosiaq)) { $gkyciwoiiisgywcs = $this->caokeucsksukesyo()->ywqgcuymeiswqyqc(); $wygwekwwaigweioa = $gkyciwoiiisgywcs->get($sogksuscggsicmac, Constants::syomkiqgogwyuiyw, []); if (is_array($wygwekwwaigweioa)) { foreach ($wygwekwwaigweioa as $ucyqiiueossykume) { if ($qcsumeqqumqgymei === $gkyciwoiiisgywcs->get($ucyqiiueossykume, Constants::qsysckqimsuoumwu)) { $ksaameoqigiaoigg = (string) $gkyciwoiiisgywcs->get($ucyqiiueossykume, Constants::gouqcwikiiygyasc, ''); break; } } } } } if ($iswcokucwmiosiaq) { $ksaameoqigiaoigg = $this->caokeucsksukesyo()->euekiyuksecoccus()->gosmqcmmomkqwmis($iswcokucwmiosiaq); } return $ksaameoqigiaoigg; } public function aecaaquaemuuascc(array $ywmkwiwkosakssii = []) { $ksaameoqigiaoigg = ''; $keccaugmemegoimu = $this->sqmuqsscmimwqoki("/zones/{$this->mekmkysuwsuseaow()}/rulesets", [Constants::qmwqkaeamecekiso => $ywmkwiwkosakssii]); if ($this->occymigcemkqucuw($keccaugmemegoimu, $iswcokucwmiosiaq)) { $sogksuscggsicmac = $this->qemyqseaomicaacs($keccaugmemegoimu); if ($this->yquuyiaogsgwmaem($sogksuscggsicmac, $iswcokucwmiosiaq)) { $ksaameoqigiaoigg = (string) $this->caokeucsksukesyo()->ywqgcuymeiswqyqc()->qamwegcyimgcqksw($sogksuscggsicmac, 'result.id', false); } } if ($iswcokucwmiosiaq || !$ksaameoqigiaoigg) { $ksaameoqigiaoigg = $this->caokeucsksukesyo()->euekiyuksecoccus()->gosmqcmmomkqwmis($iswcokucwmiosiaq); } return $ksaameoqigiaoigg; } public function kwogmsuwiyakckuo(?string $uiwqqmmiwqqqaugc) { $ksaameoqigiaoigg = false; $keccaugmemegoimu = $this->delete("/zones/{$this->mekmkysuwsuseaow()}/rulesets/{$uiwqqmmiwqqqaugc}"); if ($this->occymigcemkqucuw($keccaugmemegoimu, $iswcokucwmiosiaq)) { $ksaameoqigiaoigg = $this->yquuyiaogsgwmaem($this->qemyqseaomicaacs($keccaugmemegoimu), $iswcokucwmiosiaq); } if ($iswcokucwmiosiaq || !$ksaameoqigiaoigg) { $ksaameoqigiaoigg = $this->caokeucsksukesyo()->euekiyuksecoccus()->gosmqcmmomkqwmis($iswcokucwmiosiaq); } return $ksaameoqigiaoigg; } public function wooogwsuiygsuuso(?string $uiwqqmmiwqqqaugc) { $ksaameoqigiaoigg = []; $keccaugmemegoimu = $this->get("/zones/{$this->mekmkysuwsuseaow()}/rulesets/{$uiwqqmmiwqqqaugc}"); if ($this->occymigcemkqucuw($keccaugmemegoimu, $iswcokucwmiosiaq)) { $sogksuscggsicmac = $this->qemyqseaomicaacs($keccaugmemegoimu); if ($this->yquuyiaogsgwmaem($sogksuscggsicmac, $iswcokucwmiosiaq)) { $ksaameoqigiaoigg = (array) $this->caokeucsksukesyo()->ywqgcuymeiswqyqc()->qamwegcyimgcqksw($sogksuscggsicmac, 'result.rules', []); } } if ($iswcokucwmiosiaq) { $ksaameoqigiaoigg = $this->caokeucsksukesyo()->euekiyuksecoccus()->gosmqcmmomkqwmis($iswcokucwmiosiaq); } return $ksaameoqigiaoigg; } public function icgowyskqkokqisu(?string $uiwqqmmiwqqqaugc, array $ywmkwiwkosakssii = []) { $ksaameoqigiaoigg = ''; if ($uiwqqmmiwqqqaugc) { $keccaugmemegoimu = $this->sqmuqsscmimwqoki("/zones/{$this->mekmkysuwsuseaow()}/rulesets/{$uiwqqmmiwqqqaugc}/rules", [Constants::qmwqkaeamecekiso => $ywmkwiwkosakssii]); if ($this->occymigcemkqucuw($keccaugmemegoimu, $iswcokucwmiosiaq)) { $sogksuscggsicmac = $this->qemyqseaomicaacs($keccaugmemegoimu); if ($this->yquuyiaogsgwmaem($sogksuscggsicmac, $iswcokucwmiosiaq)) { $ksaameoqigiaoigg = (string) $this->caokeucsksukesyo()->ywqgcuymeiswqyqc()->qamwegcyimgcqksw($sogksuscggsicmac, 'result.id', false); } } } else { $iswcokucwmiosiaq = __('Ruleset ID not specified.', PR__MDL__OPTIMIZATION); } if ($iswcokucwmiosiaq || !$ksaameoqigiaoigg) { $ksaameoqigiaoigg = $this->caokeucsksukesyo()->euekiyuksecoccus()->gosmqcmmomkqwmis($iswcokucwmiosiaq); } return $ksaameoqigiaoigg; } public function koakkeimqaokakym(?string $uiwqqmmiwqqqaugc, ?string $ymawgemiwyykseqg) { $ksaameoqigiaoigg = false; $keccaugmemegoimu = $this->delete("/zones/{$this->mekmkysuwsuseaow()}/rulesets/{$uiwqqmmiwqqqaugc}/rules/{$ymawgemiwyykseqg}"); if ($this->occymigcemkqucuw($keccaugmemegoimu, $iswcokucwmiosiaq)) { $ksaameoqigiaoigg = true; } if ($iswcokucwmiosiaq) { $ksaameoqigiaoigg = $this->caokeucsksukesyo()->euekiyuksecoccus()->gosmqcmmomkqwmis($iswcokucwmiosiaq); } return $ksaameoqigiaoigg; } public function ymygowkkwyigwcea() { return $this->smayommusayuweky(self::guaqqecaewyquueo); } public function cgkaaimwgiesmwaw() { return $this->aecaaquaemuuascc([Constants::iysqkumcmmioious => Constants::qwokosymwqwyqmww, Constants::qsysckqimsuoumwu => self::guaqqecaewyquueo, Constants::eeeoygaqqmoukaeg => [], Constants::NAME => 'Cache Ruleset Created by PMPR Optimization Module']); } public function sqmcyegkigweiwks() { $this->ewcsyqaaigkicgse(Optimization::kgswyesggeyekgmg . 'cloudflare_purge_whole_cache_before'); $ksaameoqigiaoigg = false; $keccaugmemegoimu = $this->sqmuqsscmimwqoki("/zones/{$this->mekmkysuwsuseaow()}/purge_cache", [Constants::qmwqkaeamecekiso => ['purge_everything' => true]]); if ($this->occymigcemkqucuw($keccaugmemegoimu, $iswcokucwmiosiaq)) { $sogksuscggsicmac = $this->qemyqseaomicaacs($keccaugmemegoimu); if ($this->yquuyiaogsgwmaem($sogksuscggsicmac, $iswcokucwmiosiaq)) { $this->ewcsyqaaigkicgse(Optimization::kgswyesggeyekgmg . 'cloudflare_purge_whole_cache_after'); $ksaameoqigiaoigg = true; } } if ($iswcokucwmiosiaq) { $ksaameoqigiaoigg = $this->caokeucsksukesyo()->euekiyuksecoccus()->gosmqcmmomkqwmis($iswcokucwmiosiaq); } return $ksaameoqigiaoigg; } private function awkkygqayciogqym($auwuoyyagaiegwae) { $ukgsssmgkskkuoow = array_chunk($auwuoyyagaiegwae, 30); $qiouiwasaauyaaue = $this->gkwkqmwweiawigae(); try { $eeamcawaiqocomwy = "{$this->wwawisckiqeueoua()}/zones/{$this->mekmkysuwsuseaow()}/purge_cache"; foreach ($ukgsssmgkskkuoow as $wegougocoeeookww) { $this->wiwocsyueqyyakmy($eeamcawaiqocomwy, function ($keccaugmemegoimu) { $this->caokeucsksukesyo()->mskuyeumceaigegs()->debug(sprintf('Request for urls completed. %s', $this->saegmcouuukeykgi($keccaugmemegoimu))); }, function ($keccaugmemegoimu) { $this->caokeucsksukesyo()->mskuyeumceaigegs()->debug(sprintf('Request for urls failed. %s', $this->saegmcouuukeykgi($keccaugmemegoimu))); }, array_merge($qiouiwasaauyaaue, [Constants::qmwqkaeamecekiso => [Constants::cywikqeomiuewqim => array_values($wegougocoeeookww)]])); } $ksaameoqigiaoigg = true; } catch (Exception $wgaoewqkwgomoaai) { $ksaameoqigiaoigg = $this->caokeucsksukesyo()->euekiyuksecoccus()->gosmqcmmomkqwmis($wgaoewqkwgomoaai); } return $ksaameoqigiaoigg; } public function cgeuggsaswuguyqq($auwuoyyagaiegwae, bool $eaouccqceiqewoai = false) { $ksaameoqigiaoigg = false; $this->ewcsyqaaigkicgse(Optimization::kgswyesggeyekgmg . 'cloudflare_purge_cache_by_urls_before'); if ($eaouccqceiqewoai || count($auwuoyyagaiegwae) > 30) { $ksaameoqigiaoigg = $this->awkkygqayciogqym($auwuoyyagaiegwae); } else { $keccaugmemegoimu = $this->sqmuqsscmimwqoki("/zones/{$this->mekmkysuwsuseaow()}/purge_cache", ['json' => ['files' => array_values($auwuoyyagaiegwae)]]); if ($this->occymigcemkqucuw($keccaugmemegoimu, $iswcokucwmiosiaq)) { $sogksuscggsicmac = $this->qemyqseaomicaacs($keccaugmemegoimu); $ksaameoqigiaoigg = $this->yquuyiaogsgwmaem($sogksuscggsicmac, $iswcokucwmiosiaq); } } $this->ewcsyqaaigkicgse(Optimization::kgswyesggeyekgmg . 'cloudflare_purge_cache_by_urls_after'); return $ksaameoqigiaoigg; } public function yuyomsisoyaokqgu($eeamcawaiqocomwy = false) { $ksaameoqigiaoigg = false; if (!$eeamcawaiqocomwy) { $eeamcawaiqocomwy = $this->uwkmaywceaaaigwo()->giiecckwoyiawoyy()->gmigwwwmwemyaayy(); } $this->wsyymykqcoucagma(self::gqkuwmsyysusmquw)->ueakuaywsqiooygo(60)->kiaqywwoysssqgig('User-Agent', self::keasgekkgaeuueau); $askcwwaauwqisyeq = '__cfduid'; $keccaugmemegoimu = $this->get($eeamcawaiqocomwy, ['verify' => false]); if ($this->occymigcemkqucuw($keccaugmemegoimu, $iswcokucwmiosiaq)) { $osqkgokmuiasuukg = $this->wemyikwikgwqwuoc(); if ($osqkgokmuiasuukg instanceof CookieJar) { $ceiyomgiaywmmogi = $osqkgokmuiasuukg->toArray(); $gkyciwoiiisgywcs = $this->caokeucsksukesyo()->ywqgcuymeiswqyqc(); foreach ($ceiyomgiaywmmogi as $aecgggeoymywyumm) { if ($gkyciwoiiisgywcs->get($aecgggeoymywyumm, 'Name') === $askcwwaauwqisyeq) { $ksaameoqigiaoigg = $aecgggeoymywyumm; break; } } } else { $this->caokeucsksukesyo()->mskuyeumceaigegs()->iswcokucwmiosiaq('No cookies found in response HTTP packet'); } } else { $this->caokeucsksukesyo()->mskuyeumceaigegs()->iswcokucwmiosiaq($iswcokucwmiosiaq); } if (!$ksaameoqigiaoigg) { $this->caokeucsksukesyo()->mskuyeumceaigegs()->iswcokucwmiosiaq(sprintf('Cookie %s not found', $askcwwaauwqisyeq)); } return $ksaameoqigiaoigg; } private function kswoakmasgociiay(string $uusmaiomayssaecw) { $ksaameoqigiaoigg = false; $keccaugmemegoimu = $this->get("/zones/{$this->mekmkysuwsuseaow()}/settings/{$uusmaiomayssaecw}"); if ($this->occymigcemkqucuw($keccaugmemegoimu, $iswcokucwmiosiaq)) { $sogksuscggsicmac = $this->qemyqseaomicaacs($keccaugmemegoimu); if ($this->yquuyiaogsgwmaem($sogksuscggsicmac, $iswcokucwmiosiaq)) { $ksaameoqigiaoigg = $this->caokeucsksukesyo()->ywqgcuymeiswqyqc()->qamwegcyimgcqksw($sogksuscggsicmac, 'result.value', false); } else { $this->caokeucsksukesyo()->euekiyuksecoccus()->gosmqcmmomkqwmis(sprintf(__('Unable to find %s settings: %s', PR__MDL__OPTIMIZATION), $uusmaiomayssaecw, $iswcokucwmiosiaq)); } } else { $ksaameoqigiaoigg = $this->caokeucsksukesyo()->euekiyuksecoccus()->gosmqcmmomkqwmis(sprintf(__('Unable to get %s settings: %s', PR__MDL__OPTIMIZATION), $uusmaiomayssaecw, $iswcokucwmiosiaq)); } return $ksaameoqigiaoigg; } private function aawmsiaumqygusow(string $uusmaiomayssaecw, $eqgoocgaqwqcimie) { $ksaameoqigiaoigg = false; $keccaugmemegoimu = $this->kqcyawyscakoskke("{$this->wwawisckiqeueoua()}/zones/{$this->mekmkysuwsuseaow()}/settings/{$uusmaiomayssaecw}", [Constants::qmwqkaeamecekiso => [Constants::ciyoccqkiamemcmm => $eqgoocgaqwqcimie]]); if ($this->occymigcemkqucuw($keccaugmemegoimu, $iswcokucwmiosiaq)) { $ksaameoqigiaoigg = $this->yquuyiaogsgwmaem($this->qemyqseaomicaacs($keccaugmemegoimu), $iswcokucwmiosiaq); } if ($iswcokucwmiosiaq) { $ksaameoqigiaoigg = $this->caokeucsksukesyo()->euekiyuksecoccus()->gosmqcmmomkqwmis($iswcokucwmiosiaq); } return $ksaameoqigiaoigg; } public function emukusgiakigsoms($wmekckkyoiyickmk) { return $this->aawmsiaumqygusow('development_mode', $this->caokeucsksukesyo()->gyecsegqciqykomu()->ascqkksqiiwaouic($wmekckkyoiyickmk)); } public function ymkgoumkoycwwmmq() { return $this->kswoakmasgociiay('development_mode'); } }
